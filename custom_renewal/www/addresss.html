<!DOCTYPE html>
{% extends "templates/web.html" %}
import frappe
{% block page_content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<div class="container">
    <div class="row" id="page-list" data-path="renewal_list">
        <div class="sidebar-column col-sm-2">
            <div class="web-sidebar">
                {% include web_sidebar %}
            </div>
        </div>
        <div class="main-column col-sm-10">
            <div class="page-content-wrapper">
                <div class="page-breadcrumbs">

                </div>
                <main class="container ml-2">
                    <div class="page-header-wrapper">
                        <div class="page-head">
                            <h3 class="my-account-header ml-1">Address</h3>
                        </div>
                        <div class="page-header-actions-block d-flex">
                            <input type="text" id="search-bar" class="form-control" placeholder="Search..."
                                onkeyup="filterRows()" style="margin-right:5px;border-radius:10px;">
                            <a class="btn btn-primary btn-sm button-new" href="/tickets"
                                style="border-radius:10px;">create</a>
                        </div>
                    </div>
                    <div class="page_content" style="background-color: white;">

                        <div class="website-list" data-doctype="Issue" data-txt="None" style="min-height:90vh;">
                            <div class="website-list-filters pt-2">
                                <div class="dropdown-container" style="position: relative; width: 150px;">
                                    <select id="status-filter" class="form-control mb-3" placeholder="status.."
                                        onchange="filterRows()" style="width:100%;border-radius:10px;">
                                        <option value="" disabled selected hidden>Status ..</option>
                                        <option value=""></option>
                                        <option value="Open">Open</option>
                                        <option value="Replied">Replied</option>
                                        <option value="Pending">On Hold</option>
                                        <option value="Resolved">Resolved</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                    <span class="dropdown-icon material-symbols-outlined"
                                        style="position: absolute;top: 50%;right: 10px;transform: translateY(-50%);pointer-events: none;">
                                        keyboard_arrow_down
                                    </span>
                                </div>
                            </div>
                            <div id="row-container" class="result ml-5"
                                style="background-color: white;box-sizing: border-box;">

                                {% for d in doc %}
                                <div class="web-list-item transaction-list-item ml-5">
                                    <div class="row align-items-center">
                                        <div class="col-sm-3">
                                            <p class="address-title font-weight-bold">{{ d.name }}</p>
                                            <p class="address-title">{{d.address_title}}</p>
                                            <p class="address-line">
                                                {{ d.address_line1 }}, {{ d.address_line2 or '' }}
                                            </p>
                                            <p class="address-location">
                                                {{ d.city or '' }}, {{ d.state or '' }}, {{ d.country or '' }}, {{
                                                d.pincode
                                                }}
                                            </p>
                                            <a class="transaction-item-link" href="ticket?d_name={{ d.name }}">Link</a>
                                        </div>
                                        <div class="col-sm-3">
                                            <!-- <button class="btn btn-primary">Edit</button> -->
                                            <div class="col-sm-3">
                                                <button class="btn btn-primary" onclick="openEditModal(
                                                        '{{ d.name }}',
                                                        '{{ d.address_title }}',
                                                        '{{d.address_type}}',
                                                        '{{ d.address_line1 }}',
                                                        '{{ d.address_line2 or '' }}',
                                                        '{{ d.city or '' }}',
                                                        '{{ d.state or '' }}',
                                                        '{{ d.pincode }}'
                                                    )">
                                                    Edit
                                                </button>
                                            </div>

                                        </div>
                                    </div>

                                </div>
                                {% endfor %}

                            </div>
                            <div id="editModal" class="modal" tabindex="-1" role="dialog">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Edit Address</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="editForm">
                                                <input type="hidden" id="editName" name="name">
                                                <div class="form-group">
                                                    <label for="addressTitle">Address Title</label>
                                                    <input type="text" class="form-control" id="addressTitle"
                                                        name="address_title">
                                                </div>
                                                <div class="form-group">
                                                    <label for="addressType">Address Type</label>
                                                    <select class="form-control" id="addressType" name="address_type">
                                                        <option value="Billing">Billing</option>
                                                        <option value="Shipping">Shipping</option>
                                                        <option value="Home">Home</option>
                                                        <!-- Add more types as needed -->
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="addressLine1">Address Line 1</label>
                                                    <input type="text" class="form-control" id="addressLine1"
                                                        name="address_line1">
                                                </div>
                                                <div class="form-group">
                                                    <label for="addressLine2">Address Line 2</label>
                                                    <input type="text" class="form-control" id="addressLine2"
                                                        name="address_line2">
                                                </div>
                                                <div class="form-group">
                                                    <label for="city">City</label>
                                                    <input type="text" class="form-control" id="city" name="city">
                                                </div>
                                                <div class="form-group">
                                                    <label for="state">State</label>
                                                    <input type="text" class="form-control" id="state" name="state">
                                                </div>

                                                <div class="form-group">
                                                    <label for="pincode">Pincode</label>
                                                    <input type="text" class="form-control" id="pincode" name="pincode">
                                                </div>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-primary" onclick="saveChanges()">Save
                                                changes</button>
                                            <button type="button" class="btn btn-secondary"
                                                data-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <script>
                                function openEditModal(name, addressTitle, addressLine1, addressLine2, city, state, country, pincode) {
                                    // Populate the form with existing data
                                    document.getElementById('editName').value = name;
                                    document.getElementById('addressTitle').value = addressTitle;
                                    document.getElementById('addressType').value = addressType || 'Billing';
                                    document.getElementById('addressLine1').value = addressLine1;
                                    document.getElementById('addressLine2').value = addressLine2 || '';
                                    document.getElementById('city').value = city || '';
                                    document.getElementById('state').value = state || '';
                                    document.getElementById('pincode').value = pincode || '';

                                    // Show the modal
                                    $('#editModal').modal('show');
                                }

                                function saveChanges() {
                                    // Get the form data
                                    const formData = {
                                        name: document.getElementById('editName').value,
                                        address_title: document.getElementById('addressTitle').value,
                                        address_type: document.getElementById('addressType').value,
                                        address_line1: document.getElementById('addressLine1').value,
                                        address_line2: document.getElementById('addressLine2').value,
                                        city: document.getElementById('city').value,
                                        state: document.getElementById('state').value,
                                        country: "India",  // Add default value or fetch from form if needed
                                        pincode: document.getElementById('pincode').value
                                    };

                                    // Call Frappe API to update the record
                                    frappe.call({
                                        method: "frappe.client.save",
                                        args: {
                                            doc: {
                                                doctype: "Address",
                                                name: formData.name,
                                                address_title: formData.address_title,
                                                address_type: formData.address_type,
                                                address_line1: formData.address_line1,
                                                address_line2: formData.address_line2,
                                                city: formData.city,
                                                state: formData.state,
                                                country: formData.country,
                                                pincode: formData.pincode
                                            }
                                        },
                                        callback: function (response) {
                                            if (!response.exc) {
                                                // Hide the modal and refresh the page or data
                                                $('#editModal').modal('hide');
                                                location.reload();
                                            } else {
                                                alert("An error occurred while saving changes.");
                                            }
                                        }
                                    });
                                }
                            </script>



                        </div>
                        <div class="list-paging-area level" style="padding:5px">
                            <div class="level-left">
                                <div class="btn-group">
                                    <button class="btn btn-sm b1 mr-2" onclick="showRows(20, this)">20
                                    </button>
                                    <button class="btn btn-sm bl mr-2" onclick="showRows(100, this)">100
                                    </button>
                                    <button class="btn btn-sm b1 mr-2" onclick="showRows(500, this)">500
                                    </button>
                                    <button class="btn btn-sm b1" onclick="showRows(1500, this)">1500
                                    </button>
                                </div>
                            </div>
                            <div class="level-right">
                                <button class="btn " onclick="loadMoreRows()">
                                    Load More
                                </button>
                            </div>
                        </div>

                        <script>
                            rowsPerPage = 20;
                            originalRowsPerPage = rowsPerPage;
                            currentlyVisibleRows = 0;
                            isFiltered = false;

                            function showRows(count, button = null) {
                                const rows = document.querySelectorAll("#row-container .web-list-item");
                                rowsPerPage = count;

                                if (!isFiltered) {
                                    rows.forEach((row, index) => {
                                        row.style.display = index < count ? "block" : "none";
                                    });
                                    currentlyVisibleRows = count;
                                } else {
                                    applyFilter(count);
                                }
                                const buttons = document.querySelectorAll(".btn-group .btn");
                                buttons.forEach(btn => btn.classList.remove("active"));
                                if (button) button.classList.add("active");

                                const loadMoreButton = document.getElementById("load-more-btn");
                                if (currentlyVisibleRows >= rows.length || isFiltered) {
                                    loadMoreButton.style.display = "none";
                                } else {
                                    loadMoreButton.style.display = "block";
                                }

                                if (!isFiltered) {
                                    originalRowsPerPage = count;
                                }
                            }

                            function loadMoreRows() {
                                const rows = document.querySelectorAll("#row-container .web-list-item");
                                const newVisibleRows = currentlyVisibleRows + rowsPerPage;

                                if (!isFiltered) {
                                    rows.forEach((row, index) => {
                                        if (index < newVisibleRows) {
                                            row.style.display = "block";
                                        }
                                    });
                                } else {
                                    applyFilter(newVisibleRows);
                                }

                                currentlyVisibleRows = newVisibleRows;
                                const loadMoreButton = document.getElementById("load-more-btn");
                                if (currentlyVisibleRows >= rows.length) {
                                    loadMoreButton.style.display = "none";
                                }
                            }

                            function applyFilter(count) {
                                const searchInput = document.getElementById("search-bar").value.toLowerCase();
                                const selectedStatus = document.getElementById("status-filter").value.toLowerCase();
                                const rows = document.querySelectorAll("#row-container .web-list-item");

                                let visibleCount = 0;

                                rows.forEach(row => {
                                    const subject = row.querySelector(".list-item-name").textContent.toLowerCase();
                                    const status = row.querySelector(".list-item-status").textContent.toLowerCase();
                                    const raisedBy = row.querySelector(".items-name").textContent.toLowerCase();
                                    const priority = row.querySelector(".items-priority").textContent.toLowerCase();

                                    const matchesSearch = subject.includes(searchInput) ||
                                        status.includes(searchInput) ||
                                        raisedBy.includes(searchInput) ||
                                        priority.includes(searchInput);

                                    const matchesStatus = selectedStatus === "" || status === selectedStatus;

                                    if (matchesSearch && matchesStatus && visibleCount < count) {
                                        row.style.display = "block";
                                        visibleCount++;
                                    } else {
                                        row.style.display = "none";
                                    }
                                });

                                currentlyVisibleRows = visibleCount;
                                const loadMoreButton = document.getElementById("load-more-btn");
                                if (visibleCount >= rows.length) {
                                    loadMoreButton.style.display = "none";
                                } else {
                                    loadMoreButton.style.display = "block";
                                }
                            }

                            function filterRows() {
                                isFiltered = true;
                                applyFilter(rowsPerPage);
                            }

                            function clearFilters() {
                                isFiltered = false;
                                const rows = document.querySelectorAll("#row-container .web-list-item");
                                document.getElementById("search-bar").value = "";
                                document.getElementById("status-filter").value = "";

                                rows.forEach((row, index) => {
                                    row.style.display = index < originalRowsPerPage ? "block" : "none";
                                });

                                currentlyVisibleRows = originalRowsPerPage;
                                const loadMoreButton = document.getElementById("load-more-btn");
                                if (currentlyVisibleRows >= rows.length) {
                                    loadMoreButton.style.display = "none";
                                } else {
                                    loadMoreButton.style.display = "block";
                                }
                            }

                            document.addEventListener("DOMContentLoaded", () => {
                                const defaultButton = document.querySelector(".btn-group .btn");
                                showRows(rowsPerPage, defaultButton);
                            });

                        </script>
                    </div>
                </main>
            </div>
        </div>
    </div>
</div>
{% endblock %}