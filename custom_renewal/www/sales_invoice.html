{% extends "templates/web.html" %}
import frappe
{% block page_content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<div class="container">
    <div class="row" id="page-list" data-path="renewal_list">
        <div class="sidebar-column col-sm-2">
            <div class="web-sidebar">
                {% include web_sidebar %}
            </div>
        </div>
        <div class="main-column col-sm-10">
            <div class="page-content-wrapper">
                <div class="page-breadcrumbs">

                </div>
                <main class="container ml-2">
                    <div class="page-header-wrapper">
                        <div class="page-head">
                            <h3 class="my-account-header">Sales Invoice</h3>
                        </div>
                        <div class="page-header-actions-block">
                            <input type="text" id="search-bar" class="form-control" placeholder="Search..."
                                onkeyup="filterRows()">
                        </div>
                    </div>
                    <div class="page_content" style="background-color: white;min-height:90vh;">

                        <div class="website-list" data-doctype="Renewal List" data-txt="None">
                            <div class="website-list-filters">
                            </div>
                            <div id="row-container" class="result ml-5"
                                style="background-color: white;box-sizing: border-box;">
                                {% for d in doc %}
                                <div class="web-list-item transaction-list-item ml-5">
                                    <div class="row align-items-center">
                                        <div class="col-sm-3">
                                            <span class="list-item-name font-weight-bold">{{d.name}}</span>
                                            <div class="small text-muted transaction-time" title="{{transaction_date}}">
                                                {{frappe.utils.format_date(d.posting_date,"dd-MM-yyyy")}}

                                            </div>
                                        </div>
                                        <div class="col-sm-3">
                                            <span class="indicator-pill red list-item-status">{{d.status}}</span>
                                        </div>
                                        <div class="col-sm-3">
                                            <div
                                                class="small text-muted items-preview ellipsis ellipsis-width items-name">
                                                {{ d.item_name }}
                                            </div>
                                        </div>
                                        <div class="col-sm-2 text-right font-weight-bold item-total">
                                            {{d.rounded_total}}
                                        </div>
                                        <!-- {% if d.custom_invoice_attachment %}
                                        <div class="col-sm-1 text-right mt-2">
                                            <button class="btn btn-primary btn-sm"
                                                onclick="printAttachment('{{ d.custom_invoice_attachment }}')">
                                                Print
                                            </button>
                                             <a href="{{ frappe.utils.get_url(d.custom_invoice_attachment) }}"
                                                target="_blank" class="btn btn-primary btn-sm">Print</a>
                                        </div>
                                        {% endif %} -->
                                    </div>
                                    <a class="transaction-item-link" href="sales_invoices?d_name={{ d.name }}">Link</a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="pagination-controls text-left mt-4"
                            style="position:absolute; bottom: 15px; z-index: 1000; background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1); width:99%; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <button class="btn btn-sm btn-primary ml-5" onclick="setRowsLimit()">20</button>
                            </div>
                            <button class="btn btn-sm btn-secondary" style="text-align: right;"
                                onclick="loadMoreRows()">Load More</button>
                        </div>
                        <script>
                            function filterRows() {
                                const searchInput = document.getElementById("search-bar").value.toLowerCase();
                                const rows = document.querySelectorAll("#row-container .web-list-item");

                                rows.forEach(row => {
                                    const name = row.querySelector(".list-item-name").textContent.toLowerCase();
                                    const status = row.querySelector(".list-item-status").textContent.toLowerCase();
                                    const itemName = row.querySelector(".items-name").textContent.toLowerCase();
                                    const totalAmount = row.querySelector(".item-total").textContent.toLowerCase();

                                    if (
                                        name.includes(searchInput) ||
                                        status.includes(searchInput) ||
                                        itemName.includes(searchInput) ||
                                        totalAmount.includes(searchInput)
                                    ) {
                                        row.style.display = "block";
                                    } else {
                                        row.style.display = "none";
                                    }
                                });
                            }
                        </script>

                    </div>
                </main>

            </div>
        </div>

    </div>
</div>

{% endblock %}

<script>

    let currentPage = 1; // Start from the first page
    let rowsPerPage = 20; // Default rows per page
    let totalRows = 0; // Total number of rows available
    let totalPages = 0; // Total number of pages
    let searchQuery = ""; // Search query

    // Function to calculate rows and divide into 4 parts
    function calculatePagination(dataLength) {
        totalRows = dataLength;
        totalPages = Math.ceil(totalRows / 4);
        rowsPerPage = Math.ceil(totalRows / 4);
        currentPage = 1; // Reset to first page
    }

    // Function to load more rows
    function loadMoreRows() {
        if (currentPage < totalPages) {
            currentPage += 1; // Increment the page number
            fetchRows(true); // Append rows
        } else {
            alert("All rows are loaded!");
        }
    }

    // Function to fetch rows
    function fetchRows(append = false) {
        const container = document.getElementById("row-container");
        if (!append) {
            container.innerHTML = "<p>Loading...</p>"; // Show loading text if not appending
        }

        const searchInput = document.querySelector("input[name='txt']")?.value || searchQuery;
        searchQuery = searchInput; // Save the current search query

        fetch(
            `/api/method/custom_renewal.api.get_renewal_list?page=${currentPage}&limit=${rowsPerPage}&search=${encodeURIComponent(
                searchQuery
            )}`
        )
            .then((response) => response.json())
            .then((data) => {
                if (currentPage === 1) {
                    calculatePagination(data.total_rows); // Calculate pagination once on the first load
                }

                if (!append) {
                    container.innerHTML = ""; // Clear content if not appending
                }

                // Append new rows to the container
                data.message.forEach((d) => {
                    container.innerHTML += `
                    <div class="web-list-item transaction-list-item ml-5">
                        <div class="row align-items-center">
                            <div class="col-sm-2">
                                <span class="list-item-name font-weight-bold">${d.name}</span>
                                <div class="small text-muted transaction-time" title="">
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <span class="indicator-pill red list-item-status">${d.status}</span>
                            </div>
                            <div class="col-sm-2">
                                <div class="small text-muted items-preview ellipsis ellipsis-width">
                                    ${d.start_date || ""}
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <div class="small text-muted items-preview ellipsis ellipsis-width">
                                    ${d.end_date || ""}
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <div class="small text-muted items-preview ellipsis ellipsis-width">
                                    ${d.item_name || ""}
                                </div>
                            </div>
                            <div class="col-sm-2 text-right font-weight-bold item-total">
                                ${d.total_amount || ""}
                            </div>
                        </div>
                        <a class="transaction-item-link" href="renewal_lists?d_name=${d.name}">Link</a>
                    </div>
                `;
                });

                // If no data is returned
                if (!data.message.length && append) {
                    alert("No more rows to load!");
                }
            })
            .catch((error) => {
                console.error("Error fetching rows:", error);
                if (!append) {
                    container.innerHTML = "<p>Error loading rows</p>";
                }
            });
    }

    // Trigger search on form submit
    document.querySelector(".form-search").addEventListener("submit", function (e) {
        e.preventDefault(); // Prevent form submission
        currentPage = 1; // Reset to the first page for a new search
        fetchRows();
    });

    // Initial load
    document.addEventListener("DOMContentLoaded", () => {
        fetchRows();
    });

    // function printAttachment(attachment) {
    //     const baseURL = window.location.origin; // Base URL of the application
    //     const fileURL = `${baseURL}${attachment}`; // Construct full file URL

    //     if (attachment) {
    //         window.open(fileURL, '_blank');
    //     } else {
    //         alert('No attachment available for printing.');
    //     }
    // }
    function printAttachment(filePath) {
        if (!filePath) {
            alert("No file attached to print.");
            return;
        }

        const baseURL = window.location.origin; // Get the base URL of your application
        const fileURL = `${baseURL}${filePath}`; // Construct the full file URL

        // Open the PDF file in a new tab
        const newWindow = window.open(fileURL, '_blank');

        if (newWindow) {
            // Wait for the new tab to load the PDF and then trigger print
            newWindow.onload = function () {
                newWindow.print();
            };
        } else {
            alert("Unable to open the file. Please check popup blocker settings.");
        }
    }




</script>