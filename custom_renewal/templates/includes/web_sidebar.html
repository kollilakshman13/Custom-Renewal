<link rel="stylesheet"
	href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,500..700,0..1,-50..200" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
	integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
{% from "frappe/templates/includes/avatar_macro.html" import avatar %}
{% macro render_sidebar_item(item) %}
<li class="{{ 'sidebar-group' if item.group_title else 'sidebar-item' }}">
	{%- if item.group_title -%}

	<h6>{{ _(item.group_title) }}</h6>
	{{ render_sidebar_items(item.group_items) }}

	{%- else -%}

	{% if item.type != 'input' %}
	{%- set item_route = item.route[1:] if item.route[0] == '/' else item.route -%}
	<a href="{{ item.route }}" class="{{ 'active' if pathname == item.route else '' }}" {% if item.target
		%}target="{{ item.target }}" {%endif%} style="display: flex; align-items: center; gap: 0.5rem;">
		{% if item.icon %}
		<span class="material-symbols-outlined material">
			{{ item.icon }}
		</span>
		{% endif %}
		<span class="label">{{ _(item.title) or _(item.label) }}</span>
	</a>

	{% else %}
	<form action="{{ item.route }}" class="mr-4">
		<input name='q' class='form-control' type='text' style="outline: none"
			placeholder="{{ _(item.title) or _(item.label) }}">

	</form>
	{% endif %}

	{%- endif -%}
</li>
{% endmacro %}

{% macro render_sidebar_items(items) %}
{%- if items | len > 0 -%}
<ul class="list-unstyled">
	{% for item in items -%}
	{{ render_sidebar_item(item) }}
	{%- endfor %}
</ul>
{%- endif -%}
{% endmacro %}

{% macro my_account() %}
{% if frappe.user != 'Guest' %}
<ul class="list-unstyled">
	<li class="sidebar-item">
		<a href="/me" style="display: flex; align-items: center; gap: 0.5rem;">
			<span class="material-symbols-outlined material">person</span>
			<span class="label">{{ _("My Account") }}</span>
		</a>
	</li>
	<li class="sidebar-item">
		<a href="javascript:void(0)" onclick="logout()" style="display: flex; align-items: center; gap: 0.5rem;">
			<span class="material-symbols-outlined material">logout</span>
			<span class="label">{{ _("Logout") }}</span>
		</a>
	</li>
</ul>
{% endif %}
{% endmacro %}

<div class="web-sidebar">
	<div class="profile-container mb-1" onclick="toggleDropdown(event)">
		<div class="profile-row">
			<div class="profile-avatar rounded-full">
				<!-- {% set image = frappe.db.get_value('User', frappe.session.user, 'user_image') %}
				{% if image %}
				<img src="{{ image }}" class="rounded-full h-full w-full">
				{% else %}
				<img src="/files/64-Network-PNG-Logo3.png" class="rounded-full h-full w-full">
				{% endif %} -->
				<img src="/files/64-Network-PNG-Logo3.png" class="rounded-full h-full w-full">
			</div>
			<div class="profile-info">
				<p class="profile-name">Helpdesk</p>
				<p class="profile-role">
					{{ frappe.db.get_value("User", frappe.session.user, "full_name") or frappe.session.user }}
				</p>
			</div>
			<div class="profile-dropdown mr-2">
				<span class="material-symbols-outlined">keyboard_arrow_down</span>
			</div>
		</div>
	</div>
	<div id="dropdownCard" class="dropdown-card">
		<ul>
			<li class="title">
				<a href="javascript:void(0)" onclick="logout()"
					style="display: flex; align-items: center; gap: 0.5rem;">
					<span class="material-symbols-outlined" style="font-size:12px">logout</span>
					<span>{{ _("Logout") }}</span>
				</a>
			</li>
		</ul>
	</div>

	<div class="sidebar-items mt-3 ml-1">
		{{ render_sidebar_items(sidebar_items) }}
		{{ my_account() }}
	</div>
	<div class="collapse-toggle" onclick="toggleSidebar()">
		<div class="icons">
			<span class="material-symbols-outlined" style="font-size: 16px;">chevron_left</span>
			<span class="label">collapse</span>
		</div>
		<div class="start">
			<span class="material-symbols-outlined">start</span>
		</div>
	</div>
</div>


<script>
	frappe.ready(function () {
		$('.sidebar-item a').each(function (index) {
			const active_class = 'active'
			const non_active_class = ''
			let page_href = window.location.href;
			if (page_href.indexOf('#') !== -1) {
				page_href = page_href.slice(0, page_href.indexOf('#'));
			}
			if (this.href.trim() == page_href) {
				$(this).removeClass(non_active_class).addClass(active_class);
			} else {
				$(this).removeClass(active_class).addClass(non_active_class);
			}
		});

		// scroll the active sidebar item into view
		let active_sidebar_item = $('.sidebar-item a.active');
		if (active_sidebar_item.length > 0) {
			active_sidebar_item.get(0)
				.scrollIntoView({ behavior: "auto", block: "center", inline: "nearest" });
		}
	});

	function logout() {
		frappe.call({
			method: "frappe.handler.logout",
			callback: function () {
				window.location.href = "/login";
			},
			error: function (err) {
				console.error("Logout failed:", err);
			}
		});
	}

	function toggleDropdown(event) {
		event.stopPropagation();
		const dropdownCard = document.getElementById("dropdownCard");
		if (dropdownCard.style.display === "none" || !dropdownCard.style.display) {
			dropdownCard.style.display = "block";
		} else {
			dropdownCard.style.display = "none";
		}
	}

	document.addEventListener("click", () => {
		const dropdownCard = document.getElementById("dropdownCard");
		if (dropdownCard) {
			dropdownCard.style.display = "none";
		}
	});

	function toggleSidebar() {
		const sidebarColumn = document.querySelector('.sidebar-column');
		if (sidebarColumn.classList.contains('collapsed')) {
			sidebarColumn.classList.remove('collapsed');
			localStorage.setItem('sidebar-collapsed', 'false');
		} else {
			sidebarColumn.classList.add('collapsed');
			localStorage.setItem('sidebar-collapsed', 'true');
		}

	}
	document.addEventListener('DOMContentLoaded', () => {
		const sidebarColumn = document.querySelector('.sidebar-column');
		if (localStorage.getItem('sidebar-collapsed') === 'true') {
			sidebarColumn.classList.add('collapsed');
		} else {
			sidebarColumn.classList.remove('collapsed');
		}
	});


</script>